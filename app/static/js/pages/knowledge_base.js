// Knowledge Base page script extracted from inline JS for CSP compliance.
(function(){
  const I18N = JSON.parse(document.getElementById('i18n-knowledge')?.textContent || '{}');
  const projectPublicId = document.body.getAttribute('data-project-public-id');

  document.addEventListener('DOMContentLoaded', function(){
    initDropZone();
    document.getElementById('fileInput')?.addEventListener('change', e=> handleFileUpload(e.target.files));
    const focr = document.getElementById('forceFullOcrChk');
    if(focr){ focr.addEventListener('change', function(){ if(this.checked){ const msg=I18N.confirmFullOcrUpload||'Pełny OCR może być kosztowny. Kontynuować?'; if(!confirm(msg)) this.checked=false; }}); }
    document.getElementById('uploadFirstBtn')?.addEventListener('click', ()=> document.getElementById('fileInput')?.click());
    document.getElementById('uploadForm')?.addEventListener('submit', e=>{ const fi=document.getElementById('fileInput'); if(!fi || !fi.files || fi.files.length===0){ e.preventDefault(); showToast(I18N.noFileSelected||'No file selected.','danger'); return false;} e.preventDefault(); handleFileUpload(fi.files); return false; });
    try { startKnowledgeStatusPolling(); } catch(e){ console.warn('Polling init failed', e); }
    document.body.addEventListener('click', onBodyClicks);
    initSearchFilter();
    initWebSocketOrPolling();
  });

  function initDropZone(){
    const dz=document.getElementById('dropZone'); if(!dz) return; let dragCounter=0;
    ['dragenter','dragleave','dragover','drop'].forEach(ev=> dz.addEventListener(ev, e=> e.preventDefault()));
    dz.addEventListener('dragenter',()=>{ dragCounter++; dz.style.borderColor='#26a69a'; });
    dz.addEventListener('dragleave',()=>{ dragCounter--; if(dragCounter===0) dz.style.borderColor='#9e9e9e'; });
    dz.addEventListener('drop', e=>{ dragCounter=0; dz.style.borderColor='#9e9e9e'; handleFileUpload(e.dataTransfer.files); });
    dz.addEventListener('click',()=> document.getElementById('fileInput')?.click());
    dz.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); document.getElementById('fileInput')?.click(); }});
  }

  // Polling & status update
  let _knowledgeStatusTimer=null; let _lastStatuses={};
  function startKnowledgeStatusPolling(intervalMs=5000){
    async function poll(){
      try { const resp=await fetch(`/project/${projectPublicId}/knowledge/status`, {headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!resp.ok) throw new Error('Status HTTP '+resp.status); const data=await resp.json(); if(data && data.files){ applyKnowledgeStatuses(data.files); } } catch(err){ console.debug('Status poll error', err.message); } finally { _knowledgeStatusTimer=setTimeout(poll, intervalMs); }
    }
    if(_knowledgeStatusTimer) clearTimeout(_knowledgeStatusTimer); poll();
  }

  function initWebSocketOrPolling(){
    fetch(`/project/${projectPublicId}/knowledge/ws_token`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json())
      .then(j=>{ if(!j.token){ startKnowledgeStatusPolling(); return; } try { const proto=(location.protocol==='https:')?'wss':'ws'; const ws=new WebSocket(`${proto}://${location.host}/ws/knowledge/${projectPublicId}?token=${encodeURIComponent(j.token)}`); let wsActive=true; ws.onopen=()=>console.log('WS knowledge connected'); let hbInt=setInterval(()=>{ if(ws.readyState===WebSocket.OPEN){ try{ ws.send(JSON.stringify({type:'ping'})); }catch(e){} } else { clearInterval(hbInt);} },30000); ws.onmessage=ev=>{ try{ const data=JSON.parse(ev.data); if(data.type==='knowledge_snapshot'||data.type==='knowledge_delta'){ applyKnowledgeStatuses(data.files||[]);} }catch(e){} }; ws.onerror=()=>{ if(wsActive){ wsActive=false; startKnowledgeStatusPolling(); } }; ws.onclose=()=>{ if(wsActive){ wsActive=false; startKnowledgeStatusPolling(); } }; setTimeout(()=>{ if(Object.keys(_lastStatuses).length===0 && wsActive){ startKnowledgeStatusPolling(); } },7000); } catch(err){ startKnowledgeStatusPolling(); } })
      .catch(()=> startKnowledgeStatusPolling());
  }

  function applyKnowledgeStatuses(files){
    const tbody=document.querySelector('#filesTable tbody'); if(!tbody) return; const statusMap={}; files.forEach(f=>{ statusMap[f.id]=f; });
    tbody.querySelectorAll('tr.kb-file-detail[data-file-id]').forEach(tr=>{ const id=parseInt(tr.getAttribute('data-file-id')); const info=statusMap[id]; if(!info) return; const prev=_lastStatuses[id]; if(!prev||prev.status!==info.status||prev.error_message!==info.error_message||prev.chunks_count!==info.chunks_count){ const statusTd=tr.querySelector('td:nth-child(3)'); if(statusTd){ let badgeCls='secondary', label='?'; if(info.status==='uploaded'){ badgeCls='warning'; label=I18N.statusUploaded; } else if(info.status==='processing'){ badgeCls='info'; label=I18N.statusProcessing; } else if(info.status==='processed'){ badgeCls='success'; label=I18N.statusProcessed; } else if(info.status==='error'){ badgeCls='danger'; label=I18N.statusError; } statusTd.innerHTML = `<span class="badge bg-${badgeCls} text-white">${label}</span>` + (info.status==='error' && info.error_message?`<br><small class='text-danger'>${(info.error_message||'').substring(0,50)}...</small>`:''); }
      const fragmentsTd = tr.querySelector('td:nth-child(4)'); if(fragmentsTd) fragmentsTd.textContent = (info.chunks_count && info.chunks_count>0)? info.chunks_count : 0;
      if(info.status==='processed'){ const actionsTd=tr.querySelector('td:nth-child(7)'); if(actionsTd && !actionsTd.querySelector('.preview-file-btn')){ const btn=document.createElement('button'); btn.className='btn btn-sm btn-primary me-1 preview-file-btn'; btn.dataset.fileId=id; btn.title=I18N.previewTitle; btn.innerHTML='<i class="material-icons">visibility</i>'; actionsTd.prepend(btn);} }
      if(info.status==='error'){ const actionsTd=tr.querySelector('td:nth-child(7)'); if(actionsTd){ if(!actionsTd.querySelector('.retry-processing-btn')){ const rb=document.createElement('button'); rb.className='btn btn-sm btn-warning me-1 retry-processing-btn'; rb.dataset.fileId=id; rb.title=I18N.retryTitle; rb.innerHTML='<i class="material-icons">refresh</i>'; actionsTd.prepend(rb);} if(!actionsTd.querySelector('.view-error-btn')){ const eb=document.createElement('button'); eb.className='btn btn-sm btn-secondary me-1 view-error-btn'; eb.dataset.fileId=id; eb.title=I18N.errorDetailsTitle; eb.setAttribute('data-bs-toggle','modal'); eb.setAttribute('data-bs-target','#errorLogModal'); eb.innerHTML='<i class="material-icons">error_outline</i>'; actionsTd.prepend(eb);} } }
    }
    _lastStatuses[id]=info; });
  }

  // Search filtering (full dataset)
  let ALL_KNOWLEDGE_FILES=null; let ORIGINAL_TBODY_HTML=null;
  function ensureAllFilesLoaded(){ return new Promise(async resolve=>{ if(ALL_KNOWLEDGE_FILES){ resolve(ALL_KNOWLEDGE_FILES); return; } try { const resp=await fetch(`/project/${projectPublicId}/knowledge/status`, {headers:{'X-Requested-With':'XMLHttpRequest'}}); if(resp.ok){ const data=await resp.json(); ALL_KNOWLEDGE_FILES=data.files||[]; } else { ALL_KNOWLEDGE_FILES=[]; } } catch(e){ ALL_KNOWLEDGE_FILES=[]; } resolve(ALL_KNOWLEDGE_FILES); }); }
  function initSearchFilter(){ document.addEventListener('DOMContentLoaded',()=>{ const searchInput=document.getElementById('searchFiles'); if(!searchInput) return; const paginationEl=document.querySelector('.pagination'); const tbody=document.querySelector('#filesTable tbody'); if(tbody) ORIGINAL_TBODY_HTML=tbody.innerHTML; let rebuildTimer=null; searchInput.addEventListener('input', function(){ const term=this.value.trim().toLowerCase(); clearTimeout(rebuildTimer); rebuildTimer=setTimeout(async ()=>{ if(!term){ if(tbody && ORIGINAL_TBODY_HTML!==null){ tbody.innerHTML=ORIGINAL_TBODY_HTML; } if(paginationEl) paginationEl.closest('nav')?.parentElement?.classList.remove('d-none'); return; } const all=await ensureAllFilesLoaded(); const filtered=all.filter(f=>(f.filename||'').toLowerCase().includes(term)); if(paginationEl) paginationEl.closest('nav')?.parentElement?.classList.add('d-none'); if(!tbody) return; tbody.innerHTML=filtered.map(f=> buildFileRowsHtml(f)).join(''); },150); }); }); }

  function buildFileRowsHtml(f){ const fname=f.filename||''; const truncated=fname.length>100?(fname.substring(0,97)+'...'):fname; function badgeForStatus(st){ if(st==='uploaded') return `<span class="badge bg-warning text-white">${I18N.statusUploaded}</span>`; if(st==='processing') return `<span class="badge bg-info text-white">${I18N.statusProcessing}</span>`; if(st==='processed') return `<span class="badge bg-success text-white">${I18N.statusProcessed}</span>`; if(st==='error') return `<span class="badge bg-danger text-white">${I18N.statusError}</span>`; return '<span class="badge bg-secondary">?</span>'; } const uploaded=f.uploaded_at?formatDateTimeLocal(f.uploaded_at):''; const processed=f.processed_at?formatDateTimeLocal(f.processed_at):''; return `\n<tr class="kb-file-header" data-file-id="${f.id}">\n<td colspan="7" style="border-bottom:0;padding-bottom:.25rem;">\n<div class="d-flex align-items-center">\n<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2 size-40 flex-fixed-40">\n<i class="material-icons fs-6">insert_drive_file</i>\n</div>\n<a class="kb-filename fw-semibold fs-08 maxw-760 text-decoration-none text-info" title="${escapeHtml(fname)}" href="/project/${projectPublicId}/knowledge/download/${f.id}">${escapeHtml(truncated)}</a>\n</div>\n</td>\n</tr>\n<tr class="kb-file-detail" data-file-id="${f.id}">\n<td class="col-icon placeholder-cell"></td>\n<td class="col-type text-center"><span class="badge bg-light text-dark">?</span></td>\n<td class="col-status text-center">${badgeForStatus(f.status)}${f.status==='error'&&f.error_message?`<br><small class='text-danger'>${escapeHtml(f.error_message.substring(0,40))}...</small>`:''}</td>\n<td class="col-frags text-center">${f.chunks_count||0}</td>\n<td class="col-size text-center">-</td>\n<td class="col-dates text-center nowrap">${uploaded?`<small class="text-muted nowrap">${uploaded}</small>`:''}${processed?`<br><small class="text-success nowrap">${processed}</small>`:''}</td>\n<td class="col-actions text-center">${f.status==='processed'?`<button class='btn btn-sm btn-primary me-1 preview-file-btn' data-file-id='${f.id}' title='${I18N.previewTitle}'><i class="material-icons">visibility</i></button><a class='btn btn-sm btn-success me-1' href='/project/${projectPublicId}/knowledge/download/${f.id}' title='${I18N.previewTitle}'><i class="material-icons">download</i></a>`:''}${f.file_type && f.file_type.toLowerCase()==='pdf'?`<button class='btn btn-sm btn-warning me-1 force-full-ocr-btn' data-file-id='${f.id}' title='Wymuś Pełny OCR (jednorazowo)'><i class="material-icons">scanner</i></button>`:''}${f.status==='error'?`<button class='btn btn-sm btn-secondary me-1 view-error-btn' data-file-id='${f.id}' data-bs-toggle='modal' data-bs-target='#errorLogModal' title='${I18N.errorDetailsTitle}'><i class="material-icons">error_outline</i></button><button class='btn btn-sm btn-warning me-1 retry-processing-btn' data-file-id='${f.id}' title='${I18N.retryTitle}'><i class="material-icons">refresh</i></button>`:''}<button class='btn btn-sm btn-danger delete-file-btn' data-file-id='${f.id}' title='Usuń'><i class="material-icons">delete</i></button></td>\n</tr>`; }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[s])); }
  function formatDateTimeLocal(iso){ try{ const d=new Date(iso); return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}catch(e){ return iso; }}

  async function handleFileUpload(files){ if(!files||files.length===0) return; const MAX_BATCH_BYTES=100*1024*1024; let total=0; for(let f of files) total+=f.size; if(total>MAX_BATCH_BYTES){ showToast(I18N.totalSizeExceeded||'Total selected size exceeds 100 MB. Choose a smaller batch.','danger'); return; }
    const progressDiv=document.getElementById('uploadProgress'); const progressBar=document.getElementById('progressBar'); const statusDiv=document.getElementById('uploadStatus'); if(progressDiv) progressDiv.classList.remove('d-none');
    async function computeHash(file){ if(!window.crypto||!window.crypto.subtle) return null; const arrayBuffer=await file.arrayBuffer(); const hashBuffer=await crypto.subtle.digest('SHA-256', arrayBuffer); const hashArray=Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b=>b.toString(16).padStart(2,'0')).join(''); }
    const fileMetas=[]; for(let f of files){ fileMetas.push({ name:f.name, size:f.size, file:f, hash: await computeHash(f) }); }
    const csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'); let conflicts=[]; try { const resp=await fetch(`/project/${projectPublicId}/knowledge/check_duplicates`, { method:'POST', credentials:'same-origin', headers:Object.assign({'Content-Type':'application/json'}, csrfToken?{'X-CSRFToken':csrfToken,'X-CSRF-Token':csrfToken}:{}), body: JSON.stringify({ files: fileMetas.map(f=>({ filename:f.name, file_hash:f.hash })) }) }); const j=await resp.json(); conflicts=j.conflicts||[]; } catch(err){ console.warn('Duplicate check failed', err); }
    const replaceMap=new Map(); if(conflicts.length>0){ for(let c of conflicts){ const msg=(I18N.duplicateConfirm||'').replace('{filename}', c.filename).replace('{id}', c.existing_id); const ok=confirm(msg || `Replace existing file "${c.filename}" (id: ${c.existing_id})?`); replaceMap.set(c.filename, ok); } }
    for(let i=0;i<fileMetas.length;i++){ const meta=fileMetas[i]; const file=meta.file; const formData=new FormData(); formData.append('file', file); if(csrfToken) formData.append('csrf_token', csrfToken); if(meta.hash) formData.append('file_hash', meta.hash); const wantsReplace=replaceMap.has(meta.name)? replaceMap.get(meta.name):false; if(wantsReplace) formData.append('replace','true'); if(csrfToken) formData.append('csrf_token', csrfToken); try { const forceBox=document.getElementById('forceFullOcrChk'); if(forceBox && forceBox.checked && file.name.toLowerCase().endsWith('.pdf')){ formData.append('force_full_ocr','true'); } } catch(e){}
      try { if(statusDiv) statusDiv.textContent=(I18N.uploadingItem||'Uploading {i}/{n}: {name}').replace('{i}', String(i+1)).replace('{n}', String(files.length)).replace('{name}', file.name); const response=await fetch(`/project/${projectPublicId}/knowledge/upload`, { method:'POST', credentials:'same-origin', headers:Object.assign({'X-Requested-With':'XMLHttpRequest','X-Batch-Total-Size':String(total)}, csrfToken?{'X-CSRFToken':csrfToken,'X-CSRF-Token':csrfToken}:{}), body: formData }); if(progressBar) progressBar.style.width = ((i+1)/files.length*100) + '%'; const result=await response.json(); if(result.error) showToast(`Błąd przesyłania ${file.name}: ${result.error}`,'danger'); } catch(error){ showToast(`Błąd przesyłania ${file.name}: ${error.message}`,'danger'); }
    }
    if(statusDiv) statusDiv.textContent = I18N.uploadFinished || 'Upload finished. Refreshing...'; setTimeout(()=> location.reload(), 1500);
  }

  function onBodyClicks(e){ const target=e.target; const previewBtn=target.closest('.preview-file-btn'); if(previewBtn){ const id=previewBtn.getAttribute('data-file-id')||previewBtn.dataset.fileId; if(id) loadPreview(parseInt(id,10)); }
    const retryBtn=target.closest('.retry-processing-btn'); if(retryBtn){ const id=retryBtn.getAttribute('data-file-id')||retryBtn.dataset.fileId; if(id){ fetch(`/project/${projectPublicId}/knowledge/${id}/retry`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).then(j=>{ showToast(j.message||'Retry','info'); ensureAllFilesLoaded().then(()=>startKnowledgeStatusPolling()); }); } return; }
    const delBtn=target.closest('.delete-file-btn'); if(delBtn){ const id=delBtn.getAttribute('data-file-id')||delBtn.dataset.fileId; if(id && confirm(I18N.confirmDeleteShort||'Usuń plik?')){ const csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'); const headers={'X-Requested-With':'XMLHttpRequest'}; if(csrfToken){ headers['X-CSRFToken']=csrfToken; headers['X-CSRF-Token']=csrfToken; } fetch(`/project/${projectPublicId}/knowledge/${id}`, {method:'DELETE', headers, credentials:'same-origin'}).then(r=>r.json()).then(j=>{ if(j.status==='ok'){ showToast(I18N.toastRemoved||'Usunięto','success'); delBtn.closest('tr.kb-file-detail')?.previousElementSibling?.remove(); delBtn.closest('tr.kb-file-detail')?.remove(); setTimeout(()=>location.reload(), 3000); } else { showToast(j.error||I18N.toastError||'Błąd', 'danger'); } }); } return; }
    const errorBtn=target.closest('.view-error-btn'); if(errorBtn){ const id=errorBtn.getAttribute('data-file-id')||errorBtn.dataset.fileId; if(id){ loadErrorLogs(id); } }
    const forceBtn=target.closest('.force-full-ocr-btn'); if(forceBtn){ const id=forceBtn.getAttribute('data-file-id')||forceBtn.dataset.fileId; if(id){ const msg=I18N.confirmForceFullOcrFile || I18N.fullOcrConfirmFile || 'Pełny OCR może być kosztowny. Kontynuować?'; if(!confirm(msg)) return; const csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'); const headers={'X-Requested-With':'XMLHttpRequest'}; if(csrfToken){ headers['X-CSRFToken']=csrfToken; headers['X-CSRF-Token']=csrfToken; } fetch(`/project/${projectPublicId}/knowledge/${id}/force_full_ocr`, {method:'POST', headers, credentials:'same-origin'}).then(r=>r.json()).then(j=>{ if(j.message){ showToast(j.message,'info'); setTimeout(()=>location.reload(), 3500); } else if(j.error){ showToast(j.error,'danger'); } }).catch(()=> showToast('Błąd sieci','danger')); } }
  }

  function loadPreview(fileId){ const modalEl=document.getElementById('previewModal'); const previewContent=document.getElementById('previewContent'); if(previewContent){ previewContent.innerHTML='<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">'+(I18N.loading||'Loading...')+'</span></div><p class="mt-2">'+(I18N.previewLoading||'Loading preview...')+'</p></div>'; }
    let bsModal=bootstrap.Modal.getInstance(modalEl); if(!bsModal){ bsModal=new bootstrap.Modal(modalEl); } bsModal.show();
    fetch(`/project/${projectPublicId}/knowledge/${fileId}/preview`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json())
      .then(data=>{ if(data.error){ previewContent.innerHTML = `<div class='text-danger small'>${data.error}</div>`; return; } const safe=(data.content||'').replace(/</g,'&lt;'); previewContent.innerHTML = `<h6 class='mb-2'>${data.filename}</h6><pre class='kb-preview-box small p-2 border rounded pre-wrap maxh-60vh'>${safe}</pre>`; })
      .catch(()=>{ previewContent.innerHTML = `<div class='text-danger small'>${I18N.previewError||'Preview error'}</div>`; });
  }

  document.addEventListener('DOMContentLoaded', ()=>{ const modalEl=document.getElementById('previewModal'); if(modalEl){ modalEl.addEventListener('hidden.bs.modal', ()=>{ const previewContent=document.getElementById('previewContent'); if(previewContent) previewContent.innerHTML=''; const backs=document.querySelectorAll('.modal-backdrop'); if(backs.length>1){ backs.forEach((b,i)=>{ if(i<backs.length-1) b.remove(); }); } }); } });

  // showToast provided globally by ui/toast.js

  // Error log modal
  let currentLogFileId=null; let currentLogPage=1; const LOGS_PER_PAGE=20;
  function loadErrorLogs(fileId, page=1){ currentLogFileId=fileId; currentLogPage=page; const container=document.getElementById('errorLogBody'); if(!container) return; container.innerHTML = `<div class="text-muted">${I18N.loadingGeneric||'Loading...'}</div>`; fetch(`/project/${projectPublicId}/knowledge/${fileId}/logs?page=${page}&per_page=${LOGS_PER_PAGE}`, {headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).then(data=>{ if(data.error){ container.innerHTML = `<div class="text-danger">${I18N.logFetchErrorShort||'Błąd pobierania'}</div>`; return; } const items=(data.logs||[]).map(l=>`<div class="mb-3"><div><span class="badge bg-secondary text-uppercase">${l.event}</span> <small class="text-muted">${l.created_at}</small></div><pre class="small bg-light p-2 border rounded" style="white-space:pre-wrap;">${(l.message||'').replace(/</g,'&lt;')}</pre></div>`).join(''); const pagination=buildLogPagination(data.page, data.pages); container.innerHTML = items + pagination; container.querySelectorAll('.log-page-link').forEach(a=>{ a.addEventListener('click', ev=>{ ev.preventDefault(); const p=parseInt(a.dataset.page); if(p>0){ loadErrorLogs(currentLogFileId, p); } }); }); }).catch(()=>{ container.innerHTML = `<div class="text-danger">${I18N.logFetchError||'Błąd pobierania logów'}</div>`; }); }
  function buildLogPagination(page, totalPages){ if(totalPages<=1) return ''; function pageLink(p,label,disabled){ return `<li class="page-item ${disabled?'disabled':''}"><a href="#" data-page="${p}" class="page-link log-page-link">${label}</a></li>`; } let html='<nav class="mt-3"><ul class="pagination pagination-sm">'; html+=pageLink(page-1,'«', page<=1); html+=`<li class="page-item active"><span class="page-link">${page}</span></li>`; html+=pageLink(page+1,'»', page>=totalPages); html+='</ul></nav>'; return html; }
  window.loadErrorLogs = loadErrorLogs; // expose for modal triggers
})();
