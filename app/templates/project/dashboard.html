{% extends "base.html" %}

{% block title %}{{ project.name }} - {{ _('Dashboard') }}{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="project-dashboard container-fluid px-4" data-project-id="{{ project.id }}" data-project-public-id="{{ project.public_id }}">
<!-- Project Header -->
<div class="row">
    <div class="col-12 d-flex justify-content-between align-items-start flex-wrap flex-md-nowrap">
        <div class="flex-grow-1 me-3 minw-0">
            <h1 class="h3 mb-1 text-truncate">{{ project.name }}</h1>
            <div class="mb-0 line-clamp-2">
                <span class="badge bg-secondary me-2">{{ project.context }}</span>
                {{ project.description or "Brak opisu projektu" }}
            </div>
        </div>
        <div class="text-end flex-shrink-0 flex-basis-400 minw-320">
            <div><small class="me-3"><strong>{{ ID: }}</strong> {{ project.public_id }}</small></div>
            <div><small><strong>{{ Utworzony: }}</strong> <span data-local-dt="{{ project.created_at.isoformat() }}" data-only-date>{{ project.created_at.strftime('%d.%m.%Y') }}</span></small></div>
        </div>
    </div>
<!-- Main Content -->
<div class="row mt-2 g-4">
    <!-- Left Column -->
    <div class="col-12 col-md-7">
        <!-- AI Response Generator -->
        <div class="ui-panel mb-3">
            <div class="d-flex align-items-center px-3 pt-3">
                <i class="material-icons me-2">android</i>
                <h5 class="mb-0">{{ _('Generator Odpowiedzi NexuSphere') }}</h5>
            </div>
            <div class="card-body pt-2 pb-3 px-3">
                <form id="responseForm" class="ui-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
                    <div class="mb-3">
                        <label for="emailContent" class="form-label">{{ _('Treść otrzymanego emaila') }}</label>
                        <textarea id="emailContent" name="email_content" class="form-control" rows="4" placeholder="{{ Wklej tutaj treść emaila, na który chcesz wygenerować odpowiedź... }}"></textarea>
                        <div class="form-text">{{ Możesz wkleić pełną treść — system spróbuje wygenerować rzeczową odpowiedź. }}</div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="temperature" class="form-label">{{ _('Styl odpowiedzi') }}</label>
                            <select id="temperature" name="temperature" class="form-select">
                                <option value="formal">{{ Formal - Bardzo profesjonalny }}</option>
                                <option value="standard" selected>{{ Standard - Profesjonalny i przyjazny }}</option>
                                <option value="casual">{{ Casual - Swobodny ale profesjonalny }}</option>
                            </select>
                            <div class="form-text">{{ Wybierz ton odpowiedzi generowanej przez AI. }}</div>
                        </div>
                        <div class="col-6 mb-3 d-flex align-items-end">
                            <div class="w-100 d-grid gap-2 response-btn-grid">
                                <button type="submit" class="btn btn-primary flex-fill" id="generateBtn"><i class="material-icons me-1">flash_on</i> {{ _('Generuj Odpowiedź') }}</button>
                                <button type="button" class="btn btn-outline-primary flex-fill" id="searchFragmentsBtn"><i class="material-icons me-1">travel_explore</i> {{ _('Wyszukaj fragmenty') }}</button>
                            </div>
                        </div>
                    </div>
                </form>

                <div id="responseResult" class="mt-3 d-none">
                    <hr>
                    <h6 class="mb-2">{{ _('Wygenerowana odpowiedź') }}</h6>
                    <div class="ui-panel mb-2">
                        <div class="card-body p-3" id="generatedResponse"></div>
                    </div>
                    <div class="text-end text-muted">
                        <span id="tokensUsed"></span>
                    </div>
                </div>

                <div id="fragmentsResult" class="mt-3 d-none">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">{{ _('Fragmenty użyte do odpowiedzi') }}</h6>
                        <span class="badge bg-dark" id="fragmentsCount">0</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle table-sm" id="fragmentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">{{ _('Plik') }}</th>
                                    <th scope="col" class="text-nowrap">{{ _('Fragment ID') }}</th>
                                    <th scope="col" class="text-nowrap">{{ _('Wynik rerankera') }}</th>
                                    <th scope="col" class="text-center">{{ _('Podgląd') }}</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-12 col-md-5">
        <!-- Quick Actions -->
        <div class="ui-panel mb-3">
            <div class="d-flex align-items-center px-3 pt-3">
                <i class="material-icons me-2">bolt</i>
                <h5 class="mb-0">{{ _('Akcje') }}</h5>
            </div>
            <div class="card-body pt-2 pb-3 px-3">
                <div class="list-group project-actions-list">
                    <a href="{{ url_for('project.knowledge_base', project_public_id=project.public_id) }}" class="list-group-item list-group-item-action d-flex align-items-center action-item">
                        <i class="material-icons me-3 text-success">file_upload</i>
                        <div>
                            <div class="fw-bold">{{ _('Prześlij Pliki') }}</div>
                            <div class="small text-muted">{{ _('Dodaj dokumenty do bazy wiedzy') }}</div>
                        </div>
                    </a>
                    <a href="{{ url_for('project.email_accounts', project_public_id=project.public_id) }}" class="list-group-item list-group-item-action d-flex align-items-center action-item">
                        <i class="material-icons me-3 text-primary">email</i>
                        <div>
                            <div class="fw-bold">{{ _('Konta Email') }}</div>
                            <div class="small text-muted">{{ _('Zarządzaj kontami email') }}</div>
                        </div>
                    </a>
                    <a href="{{ url_for('project.project_config', project_public_id=project.public_id) }}" class="list-group-item list-group-item-action d-flex align-items-center action-item">
                        <i class="material-icons me-3 text-muted">settings</i>
                        <div>
                            <div class="fw-bold">{{ _('Ustawienia') }}</div>
                            <div class="small text-muted">{{ _('Konfiguracja projektu') }}</div>
                        </div>
                    </a>
                    <a href="{{ url_for('project.project_history', project_public_id=project.public_id) }}" class="list-group-item list-group-item-action d-flex align-items-center action-item">
                        <i class="material-icons me-3 text-info">history</i>
                        <div>
                            <div class="fw-bold">{{ _('Historia odpowiedzi') }}</div>
                            <div class="small text-muted">{{ _('Przeglądaj zapisane generacje AI') }}</div>
                        </div>
                    </a>
                    {# On-demand date-range modal trigger for project report #}
                    <button type="button" id="projectReportTrigger" class="list-group-item list-group-item-action d-flex align-items-center action-item" data-base-url="{{ url_for('project.project_email_generation_report', project_public_id=project.public_id) }}">
                        <i class="material-icons me-3 text-warning">download</i>
                        <div>
                            <div class="fw-bold">{{ Raport (zakres dat) }}</div>
                            <div class="small text-muted">{{ _('Wybierz przedział i pobierz CSV') }}</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Email Accounts Status -->
        <div class="ui-panel mb-3">
            <div class="d-flex align-items-center px-3 pt-3">
                <i class="material-icons me-2">email</i>
                <h5 class="mb-0">{{ _('Status Kont Email') }}</h5>
            </div>
            <div class="card-body pt-2 pb-3 px-3">
                {% if email_accounts %}
                <ul class="list-group">
                    {% for account in email_accounts %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ account.email }}</div>
                            <small class="text-muted">{{ account.provider }}{% if account.last_checked %} - {{ Ostatnie sprawdz.: }} <span data-local-dt="{{ account.last_checked.isoformat() }}">{{ account.last_checked.strftime('%d.%m.%Y %H:%M') }}</span>{% else %} - {{ _('Brak sprawdzenia') }}{% endif %}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge {{ 'bg-success' if account.status == 'connected' else 'bg-danger' }}">{{ _(account.status.title()) }}</span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-4">
                    <i class="material-icons display-4">email</i>
                    <p class="text-center">{{ _('Brak kont email') }}</p>
                    <a href="{{ url_for('project.email_accounts', project_public_id=project.public_id) }}" class="btn btn-primary">{{ _('Dodaj Konto') }}</a>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>
</div>

<!-- Fragment preview modal -->
<div class="modal fade" id="fragmentPreviewModal" tabindex="-1" aria-labelledby="fragmentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fragmentPreviewModalLabel">{{ _('Podgląd fragmentu') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Zamknij') }}"></button>
            </div>
            <div class="modal-body">
                <div class="small mb-2" id="fragmentPreviewMeta"></div>
                <pre class="small mb-0" id="fragmentPreviewContent"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Zamknij') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- i18n payload for dashboard scripts (parsed at runtime) -->
<script id="i18n-dashboard" type="application/json">{{ {
    'tokensMonthlyShort': "tokenów (mies.)",
    'tokensMonthlyLong': "tokenów (miesięcznie)",
    'limitExceeded': "przekroczono limit tokenów",
    'enterEmailContent': "Proszę wprowadzić treść emaila",
    'generatingResponse': "Generowanie odpowiedzi...",
    'noStructuredResponse': "Brak ustrukturyzowanej odpowiedzi (response_json.email.body).",
    'tokensUsed': "Wykorzystano",
    'tokensWord': "tokenów",
    'invalidResponseType': "Niepoprawny typ odpowiedzi (oczekiwano JSON).",
    'jsonParseError': "Błąd parsowania JSON:",
    'connectionError': "Błąd połączenia:",
    'fragmentsWord': "fragmentów",
    'overflowWarning': "Projekt w stanie overflow (brak nowych uploadów)",
    'reportDialogTitle': "Raport projektu",
    'dateFrom': "Od",
    'dateTo': "Do",
    'quickRanges': "Szybkie zakresy",
    'prevMonth': "Poprzedni miesiąc",
    'prev3Months': "Poprzednie 3 miesiące",
    'downloadAllInfo': "Pozostaw puste aby pobrać wszystkie dane.",
    'preview': "Podgląd",
    'fragmentId': "Fragment ID",
    'rerankScore': "Wynik rerankera",
    'modalNoContent': "Brak treści do wyświetlenia.",
    'noMetadata': "Brak dodatkowych metadanych.",
    'clear': "Wyczyść",
    'cancel': "Anuluj",
    'generate': "Generuj",
    'reportMissingUrl': "Brak adresu raportu",
    'dateRangeInvalid': "Data "Od" nie może być późniejsza niż "Do""
}|tojson }}</script>
<script src="{{ url_for('static', filename='js/pages/project_dashboard.js') }}" nonce="{{ csp_nonce() }}" defer></script>
{% endblock %}
